<!DOCTYPE html>
<html>
	<head>
		<title>LINQ to SQL Gotcha #6: Delete, Save, Insert, CRASH</title>
		<link rel="stylesheet" type="text/css" href="/resources/css/style.css">
	</head>

	<body>
		<div id="div_header">
			<h1><a href="/">Graeme Hill's Dev Blog</a></h1>
		</div>

		<div id="div_content">
			<div class="div_article">
	<div class="div_article_header">
		<h1><a href="/linq-to-sql-gotcha-6-delete-save-insert-crash">LINQ to SQL Gotcha #6: Delete, Save, Insert, CRASH</a></h1>
		<p>2010.091</p>
	</div>
	<div class="div_article_content">
		<p>If you keep the same entity around after it has been deleted and <code>SubmitChanges()</code> is called then you can run into an <code>InvalidOperationException</code> if you try to insert it again<!--break-->.</p>

<pre><code>var data = new DataClasses1DataContext();
var user = new User() { userName = "foo", password = "bar" };

data.Users.InsertOnSubmit(user);
data.SubmitChanges();

data.Users.DeleteOnSubmit(user);
data.SubmitChanges();

data.Users.InsertOnSubmit(user);
data.SubmitChanges();
</code></pre>

<p>Here you will actually get an exception on the second <code>InsertOnSubmit()</code> because the data context remembered the entity and will no longer allow you to attach it for some reason.  Once an entity has been deleted from a data context it can never go back.  To get around this you need to either insert the entity to a different data context or copy the data to a new instance of the same entity class and then insert it.  This has been confirmed <a href="http://social.msdn.microsoft.com/Forums/en-US/linqprojectgeneral/thread/6602af13-1d27-4f9a-b7e0-9c58238f6c55">here</a>.</p>

<p>Note: You are free to call <code>DeleteOnSubmit()</code> and then <code>InsertOnSubmit()</code> all you want as long as you never call <code>SubmitChanges()</code>.</p>

	</div>
</div>
		</div>

		<script type="text/javascript">
		  var _gaq = _gaq || [];
		  _gaq.push(['_setAccount', 'UA-3499720-4']);
		  _gaq.push(['_trackPageview']);

		  (function() {
		    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		  })();
		</script>
	</body>
</html>