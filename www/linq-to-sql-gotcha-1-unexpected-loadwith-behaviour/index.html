<!DOCTYPE html>
<html>
	<head>
		<title>LINQ to SQL Gotcha #1: Unexpected LoadWith Behaviour</title>
		<link rel="stylesheet" type="text/css" href="/resources/css/style.css">
	</head>

	<body>
		<div id="div_header">
			<h1><a href="/">Graeme Hill's Dev Blog</a></h1>
		</div>

		<div id="div_content">
			<div class="div_article">
	<div class="div_article_header">
		<h1><a href="/linq-to-sql-gotcha-1-unexpected-loadwith-behaviour">LINQ to SQL Gotcha #1: Unexpected LoadWith Behaviour</a></h1>
		<p>2010.031</p>
	</div>
	<div class="div_article_content">
		<p>By default, LINQ to SQL uses deferred loading.  When you want to eager load an entity's associated data you need to set <code>DataLoadOptions</code> using the <code>LoadOptions</code> property on the <code>DataContext</code>.  If you have a one-to-many relationship between <code>Users</code> and <code>Articles</code> you can force LINQ to SQL to eager load <code>Articles</code> with <code>Users</code> like this<!--break-->:</p>

<pre><code>Using testData As New TestDataContext

    ' Log SQL queries to the console
    testData.Log = Console.Out

    ' Set LoadOptions
    Dim options As New DataLoadOptions
    options.LoadWith(Function(user As User) user.Articles)
    testData.LoadOptions = options

    ' Load users with their articles
    Dim users = testData.Users.ToList
    For Each user In users
        Dim articles = user.Articles.ToList
    Next

End Using
</code></pre>

<p>This will generate a single <code>SELECT</code> statement with a <code>JOIN</code> on the <code>Articles</code> table.  The same goes for for one-to-one relationships.  You can also use <code>LoadWith</code> as many times as you want.  For one-to-one relationships and no more than a single one-to-many relationship this will still generate one query with <code>JOIN</code>s to all the <code>LoadWith</code> tables.  However, if you want to eager load multiple one-to-many relationships you will get into a select N + 1 situation (or worse).  For example, this code eager loads <code>Articles</code> and <code>UserGroups</code> with each <code>User</code> entity:</p>

<pre><code>Using testData As New TestDataContext

    ' Log SQL queries to the console
    testData.Log = Console.Out

    ' Set LoadOptions
    Dim options As New DataLoadOptions
    options.LoadWith(Function(user As User) user.Articles)
    options.LoadWith(Function(user As User) user.UserGroups)
    testData.LoadOptions = options

    ' Load users with their articles
    Dim users = testData.Users.ToList
    For Each user In users
        Dim articles = user.Articles.ToList
        Dim userGroups = user.UserGroups.ToList
    Next

End Using
</code></pre>

<p>Technically, the behaviour here is correct.  It will successfully eager load both the <code>Articles</code> and <code>UserGroups</code> collections for each <code>User</code>, but it will <em>not</em> do it in a single query.  When I ran this I got one query that fetched the <code>Users</code> and <code>Articles</code> like last time, but then a separate <code>SELECT</code> for each <code>UserGroup</code> rather than another <code>JOIN</code>.  Even though this won't alter the behaviour of the code, it will definitely make a major impact on performance, especially if there are a lot of users in the database.</p>

<p>Scott Guthrie confirmed this behaviour in a <a href="http://codebetter.com/blogs/david.hayden/archive/2007/08/06/linq-to-sql-query-tuning-appears-to-break-down-in-more-advanced-scenarios.aspx">post on David Hayden's blog</a>.  This is what he said:</p>

<blockquote>
  <p>In the case of a 1:n associations, LINQ to SQL only supports joining-in one 1:n association per query.</p>
</blockquote>

<p>Lame.</p>

	</div>
</div>
		</div>

		<script type="text/javascript">
		  var _gaq = _gaq || [];
		  _gaq.push(['_setAccount', 'UA-3499720-4']);
		  _gaq.push(['_trackPageview']);

		  (function() {
		    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		  })();
		</script>
	</body>
</html>