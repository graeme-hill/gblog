<!DOCTYPE html>
<html>
	<head>
		<title>.NET reflection: don't rely on the call stack, it's a trap!</title>
		<link rel="stylesheet" type="text/css" href="/resources/css/style.css">
	</head>

	<body>
		<div id="div_header">
			<h1><a href="/">Graeme Hill's Dev Blog</a></h1>
		</div>

		<div id="div_content">
			<div class="div_article">
	<div class="div_article_header">
		<h1><a href="/net-reflection-dont-rely-on-the-call-stack-its-a-trap">.NET reflection: don't rely on the call stack, it's a trap!</a></h1>
		<p>2011.299</p>
	</div>
	<div class="div_article_content">
		<p>In recent memory I have twice tried to write reflection code that seemed totally badass at the time but turned out to be just plain bad.  One case involved the use of <code>GetCallingAssembly()</code> and the other involved navigating the stack trace with <code>stackTrace.GetFrame(1)</code>.  While there is nothing inherently wrong with these functions (ie: they can be used perfectly fine for logging or debugging) you absolutely cannot depend on a specific result due to runtime optimizations by the .NET JIT compiler.  For example<!--break-->, imagine A calls B and B calls C. If C runs <code>GetCallingAssembly()</code> then you would expect to get the assembly of B; however, if function B gets inlined in A (which is not uncommon) then technically A is directly calling C, and you will actually get A as a result!  In fact, if you check the <a href="http://msdn.microsoft.com/en-us/library/system.reflection.assembly.getcallingassembly.aspx">MSDN documentation</a> they even warn you about this: </p>

<blockquote>
  <p>If the method that calls the GetCallingAssembly method is expanded inline by the just-in-time (JIT) compiler, or if its caller is expanded inline, the assembly that is returned by GetCallingAssembly may differ unexpectedly.</p>
</blockquote>

<p>The documentation for <code>GetExecutingAssembly()</code> has no such warning, but just to be safe I prefer to be explicit with something like this: <code>myObject.GetType().Assembly</code></p>

	</div>
</div>
		</div>

		<script type="text/javascript">
		  var _gaq = _gaq || [];
		  _gaq.push(['_setAccount', 'UA-3499720-4']);
		  _gaq.push(['_trackPageview']);

		  (function() {
		    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		  })();
		</script>
	</body>
</html>